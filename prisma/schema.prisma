generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                   String                   @id @default(cuid())
  walletAddress        String?                  @unique
  role                 UserRole                 @default(USER)
  createdAt            DateTime                 @default(now())
  email                String?                  @unique
  supabaseId           String?                  @unique
  passHash             String?
  solWallet            String?                  @unique
  solWalletLinkedAt    DateTime?
  welcomeEmailSentAt   DateTime?
  mvmPoints            Int                      @default(0)

  // Referrals
  referralCode         String?                  @unique
  referredById         String?
  referredBy           User?                    @relation("UserReferrals", fields: [referredById], references: [id])
  referrals            User[]                   @relation("UserReferrals")
  referredAt           DateTime?

  commentsAuthored     Comment[]                @relation("CommentAuthor")
  commentsRemoved      Comment[]                @relation("CommentRemovedBy")
  memberVotes          CommentMemberVote[]
  modVotes             CommentModVote[]
  integrityFlagsAuthor ModeratorIntegrityFlag[] @relation("FlaggedAuthor")
  integrityFlagsMod    ModeratorIntegrityFlag[] @relation("FlaggedMod")
  passwordResetTokens  PasswordResetToken[]
  sessions             Session[]
  subscription         Subscription?
  scoreAdjustments     VideoScoreAdjustment[]
  starRatings          VideoStarRating[]
  walletLinkChallenges WalletLinkChallenge[]
  sourceGradesMade     CommentSourceGrade[]     @relation("CommentSourceGradeMod")
  sourceGradesEarned   CommentSourceGrade[]     @relation("CommentSourceGradeAuthor")
  rewardEvents         RewardEvent[]
  weeklyStats          WeeklyUserStat[]
  allTimeStat          AllTimeUserStat?
  monthlyStats         MonthlyUserStat[]
  weeklyVoterStats     WeeklyVoterStat[]

  @@index([referredById])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model WalletLinkChallenge {
  id        String    @id @default(cuid())
  userId    String
  nonce     String    @unique
  message   String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id            String    @id @default(cuid())
  userId        String
  tokenHash     String    @unique
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())
  resendEmailId String?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([resendEmailId])
}

model PasswordResetAttempt {
  id        String   @id @default(cuid())
  email     String
  ip        String
  userAgent String?
  action    String
  allowed   Boolean
  reason    String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ip, createdAt])
  @@index([action, createdAt])
}

model ResendWebhookEvent {
  id            String   @id @default(cuid())
  svixId        String   @unique
  svixTimestamp String?
  svixSignature String?
  type          String
  createdAt     DateTime @default(now())
  resendEmailId String?
  to            String?
  from          String?
  subject       String?
  payload       Json

  @@index([type, createdAt])
  @@index([resendEmailId])
  @@index([to])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  tier                 SubscriptionTier
  status               SubscriptionStatus @default(PENDING)
  expiresAt            DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  nowPaymentsPaymentId String?
  nowPaymentsInvoiceId String?
  lastTxSig            String?
  nowPaymentsOrderId   String?            @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([expiresAt])
}

model Video {
  id           String                 @id @default(cuid())
  slug         String                 @unique
  title        String
  embedUrl     String
  tags         String[]               @default([])
  createdAt    DateTime               @default(now())
  isShowcase   Boolean                @default(false)
  adminScore   Int                    @default(75)
  sourceViews  Int                    @default(0) // Original views from source platform
  viewsCount   Int                    @default(0) // Xessex page views
  avgStars     Float                  @default(0)
  starsCount   Int                    @default(0)
  thumbnailUrl String?
  comments     Comment[]
  adjustments  VideoScoreAdjustment[]
  starRatings  VideoStarRating[]
  sourceGrades CommentSourceGrade[]

  @@index([isShowcase])
}

model VideoStarRating {
  id        String   @id @default(cuid())
  videoId   String
  userId    String
  stars     Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([userId])
}

model Comment {
  id               String                 @id @default(cuid())
  videoId          String
  authorId         String
  body             String
  createdAt        DateTime               @default(now())
  status           CommentStatus          @default(ACTIVE)
  removedById      String?
  removedAt        DateTime?
  removedReason    String?
  memberDislikes   Int                    @default(0)
  memberLikes      Int                    @default(0)
  score            Int                    @default(0)
  author           User                   @relation("CommentAuthor", fields: [authorId], references: [id])
  removedBy        User?                  @relation("CommentRemovedBy", fields: [removedById], references: [id])
  video            Video                  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  memberVotes      CommentMemberVote[]
  modVotes         CommentModVote[]
  scoreAdjustments VideoScoreAdjustment[]
  sourceGrades     CommentSourceGrade[]

  @@index([videoId])
  @@index([authorId])
  @@index([status])
}

model CommentMemberVote {
  id            String   @id @default(cuid())
  commentId     String
  voterId       String
  value         Int
  flipCount     Int      @default(0)
  lastChangedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  comment       Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  voter         User     @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([commentId, voterId])
  @@index([voterId])
}

model CommentModVote {
  id            String   @id @default(cuid())
  commentId     String
  modId         String
  value         Int
  flipCount     Int      @default(0)
  lastChangedAt DateTime @default(now())
  comment       Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mod           User     @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@unique([commentId, modId])
  @@index([modId])
}

model VideoScoreAdjustment {
  id        String   @id @default(cuid())
  videoId   String
  commentId String
  modId     String
  direction Int
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mod       User     @relation(fields: [modId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([commentId])
  @@index([modId])
}

model ModeratorIntegrityFlag {
  id         String    @id @default(cuid())
  modId      String
  authorId   String
  reason     String
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  author     User      @relation("FlaggedAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  mod        User      @relation("FlaggedMod", fields: [modId], references: [id], onDelete: Cascade)

  @@index([modId])
  @@index([authorId])
}

model RateLimit {
  id          String @id @default(cuid())
  scope       String
  key         String
  windowStart Int
  count       Int    @default(0)

  @@unique([scope, key, windowStart])
  @@index([scope, key, windowStart])
}

model VoteEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    String?
  commentId String
  ip        String
  userAgent String?
  action    String
  vote      Int?
  prevVote  Int?

  @@index([ip, createdAt])
  @@index([userId, createdAt])
}

model CommentSourceGrade {
  id        String   @id @default(cuid())
  commentId String
  videoId   String
  modId     String
  authorId  String
  direction Int
  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  video   Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)
  mod     User    @relation("CommentSourceGradeMod", fields: [modId], references: [id], onDelete: Cascade)
  author  User    @relation("CommentSourceGradeAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@unique([commentId, modId])
  @@index([authorId, createdAt])
  @@index([videoId, createdAt])
  @@index([modId, createdAt])
}

enum UserRole {
  USER
  MOD
  ADMIN
}

enum SubscriptionTier {
  MEMBER
  DIAMOND
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  PENDING
  PARTIAL
}

enum CommentStatus {
  ACTIVE
  REMOVED
}

model SiteStat {
  key       String   @id
  value     BigInt   @default(0)
  updatedAt DateTime @updatedAt
}

// ============================================
// REWARDS SYSTEM
// ============================================

enum RewardStatus {
  PENDING
  PROCESSING
  PAID
  VOID
}

enum RewardType {
  WEEKLY_LIKES
  WEEKLY_MVM
  WEEKLY_COMMENTS
  WEEKLY_VOTER
  ALLTIME_LIKES
  REF_L1
  REF_L2
  REF_L3
}

model RewardEvent {
  id          String       @id @default(cuid())
  userId      String
  type        RewardType
  amount      BigInt
  status      RewardStatus @default(PENDING)

  weekKey     String       // e.g. "2024-W03"

  refType     String       // e.g. "like", "mvm", "ref"
  refId       String       // e.g. comment ID or user ID

  txSig       String?      // Solana transaction signature
  createdAt   DateTime     @default(now())
  paidAt      DateTime?

  // Merkle claim fields
  merkleIndex Int?
  merkleProof String?
  claimedAt   DateTime?

  user        User         @relation(fields: [userId], references: [id])

  @@unique([refType, refId])
  @@index([weekKey, status])
  @@index([userId, status])
  @@index([type, status])
}

model WeeklyUserStat {
  id              String   @id @default(cuid())
  weekKey         String
  userId          String

  diamondComments Int      @default(0)
  mvmPoints       Int      @default(0)
  scoreReceived   Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])

  @@unique([weekKey, userId])
  @@index([weekKey])
}

// Admin-configurable thresholds (singleton)
model AdminConfig {
  id String @id @default(cuid())

  // Thresholds (admin adjustable)
  minWeeklyScoreThreshold Int @default(10) // Weekly leaderboard eligibility (scoreReceived)
  minMvmThreshold         Int @default(1)  // MVM eligibility

  // Pool slices (basis points, 10000 = 100%)
  // These are slices of the LIKES POOL (which is 75% of emission after ref budget)
  allTimeLikesBpsOfLikes Int @default(1000) // 10% of likes pool -> all-time leaderboard
  memberVoterBpsOfLikes  Int @default(500)  // 5% of likes pool -> member voter incentives

  // Voter payout sizing (atomic XESS units)
  voterRewardPerVoteAtomic BigInt @default(0) // set later; 0 = use pool split instead

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// All-time cumulative stats (for all-time leaderboard)
model AllTimeUserStat {
  userId        String   @id
  scoreReceived Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
}

// Monthly MVM tracking (resets monthly, weekly payouts)
model MonthlyUserStat {
  id        String   @id @default(cuid())
  monthKey  String   // "2026-01"
  userId    String
  mvmPoints Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([monthKey, userId])
  @@index([monthKey])
}

// Weekly voter stats (for member voter rewards)
model WeeklyVoterStat {
  id        String   @id @default(cuid())
  weekKey   String
  userId    String
  votesCast Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([weekKey, userId])
  @@index([weekKey])
}

// Merkle batch for weekly distribution
model RewardBatch {
  id          String   @id @default(cuid())
  weekKey     String   @unique
  merkleRoot  String
  totalAmount BigInt
  totalUsers  Int
  createdAt   DateTime @default(now())
}
