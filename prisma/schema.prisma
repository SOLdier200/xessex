generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                   String                   @id @default(cuid())
  walletAddress        String?                  @unique
  role                 UserRole                 @default(USER)
  createdAt            DateTime                 @default(now())
  email                String?                  @unique
  supabaseId           String?                  @unique
  passHash             String?
  solWallet            String?                  @unique
  solWalletLinkedAt    DateTime?
  welcomeEmailSentAt   DateTime?
  commentsAuthored     Comment[]                @relation("CommentAuthor")
  commentsRemoved      Comment[]                @relation("CommentRemovedBy")
  memberVotes          CommentMemberVote[]
  modVotes             CommentModVote[]
  integrityFlagsAuthor ModeratorIntegrityFlag[] @relation("FlaggedAuthor")
  integrityFlagsMod    ModeratorIntegrityFlag[] @relation("FlaggedMod")
  passwordResetTokens  PasswordResetToken[]
  sessions             Session[]
  subscription         Subscription?
  scoreAdjustments     VideoScoreAdjustment[]
  starRatings          VideoStarRating[]
  walletLinkChallenges WalletLinkChallenge[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model WalletLinkChallenge {
  id        String    @id @default(cuid())
  userId    String
  nonce     String    @unique
  message   String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id            String    @id @default(cuid())
  userId        String
  tokenHash     String    @unique
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())
  resendEmailId String?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([resendEmailId])
}

model PasswordResetAttempt {
  id        String   @id @default(cuid())
  email     String
  ip        String
  userAgent String?
  action    String
  allowed   Boolean
  reason    String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ip, createdAt])
  @@index([action, createdAt])
}

model ResendWebhookEvent {
  id            String   @id @default(cuid())
  svixId        String   @unique
  svixTimestamp String?
  svixSignature String?
  type          String
  createdAt     DateTime @default(now())
  resendEmailId String?
  to            String?
  from          String?
  subject       String?
  payload       Json

  @@index([type, createdAt])
  @@index([resendEmailId])
  @@index([to])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  tier                 SubscriptionTier
  status               SubscriptionStatus @default(PENDING)
  expiresAt            DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  nowPaymentsPaymentId String?
  nowPaymentsInvoiceId String?
  lastTxSig            String?
  nowPaymentsOrderId   String?            @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([expiresAt])
}

model Video {
  id           String                 @id @default(cuid())
  slug         String                 @unique
  title        String
  embedUrl     String
  tags         String[]               @default([])
  createdAt    DateTime               @default(now())
  isShowcase   Boolean                @default(false)
  adminScore   Int                    @default(50)
  viewsCount   Int                    @default(0)
  avgStars     Float                  @default(0)
  starsCount   Int                    @default(0)
  thumbnailUrl String?
  comments     Comment[]
  adjustments  VideoScoreAdjustment[]
  starRatings  VideoStarRating[]

  @@index([isShowcase])
}

model VideoStarRating {
  id        String   @id @default(cuid())
  videoId   String
  userId    String
  stars     Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([userId])
}

model Comment {
  id               String                 @id @default(cuid())
  videoId          String
  authorId         String
  body             String
  createdAt        DateTime               @default(now())
  status           CommentStatus          @default(ACTIVE)
  removedById      String?
  removedAt        DateTime?
  removedReason    String?
  memberDislikes   Int                    @default(0)
  memberLikes      Int                    @default(0)
  author           User                   @relation("CommentAuthor", fields: [authorId], references: [id])
  removedBy        User?                  @relation("CommentRemovedBy", fields: [removedById], references: [id])
  video            Video                  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  memberVotes      CommentMemberVote[]
  modVotes         CommentModVote[]
  scoreAdjustments VideoScoreAdjustment[]

  @@index([videoId])
  @@index([authorId])
  @@index([status])
}

model CommentMemberVote {
  id            String   @id @default(cuid())
  commentId     String
  voterId       String
  value         Int
  flipCount     Int      @default(0)
  lastChangedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  comment       Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  voter         User     @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([commentId, voterId])
  @@index([voterId])
}

model CommentModVote {
  id            String   @id @default(cuid())
  commentId     String
  modId         String
  value         Int
  flipCount     Int      @default(0)
  lastChangedAt DateTime @default(now())
  comment       Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mod           User     @relation(fields: [modId], references: [id], onDelete: Cascade)

  @@unique([commentId, modId])
  @@index([modId])
}

model VideoScoreAdjustment {
  id        String   @id @default(cuid())
  videoId   String
  commentId String
  modId     String
  direction Int
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mod       User     @relation(fields: [modId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([commentId])
  @@index([modId])
}

model ModeratorIntegrityFlag {
  id         String    @id @default(cuid())
  modId      String
  authorId   String
  reason     String
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  author     User      @relation("FlaggedAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  mod        User      @relation("FlaggedMod", fields: [modId], references: [id], onDelete: Cascade)

  @@index([modId])
  @@index([authorId])
}

model RateLimit {
  id          String @id @default(cuid())
  scope       String
  key         String
  windowStart Int
  count       Int    @default(0)

  @@unique([scope, key, windowStart])
  @@index([scope, key, windowStart])
}

model VoteEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    String?
  commentId String
  ip        String
  userAgent String?
  action    String
  vote      Int?
  prevVote  Int?

  @@index([ip, createdAt])
  @@index([userId, createdAt])
}

enum UserRole {
  USER
  MOD
  ADMIN
}

enum SubscriptionTier {
  MEMBER
  DIAMOND
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  PENDING
}

enum CommentStatus {
  ACTIVE
  REMOVED
}
